<!doctype html>
<html>
    <head>
        <title>FRC #7589 | Scouting</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="./assets/app.css" rel="stylesheet">
        <link href="./manifest.json" rel="manifest">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>

        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" type="text/javascript"></script>
        <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js" type="text/javascript"></script>
        <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js" type="text/javascript"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" type="text/javascript"></script>
        
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js" type="text/javascript"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js" type="text/javascript"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js" type="text/javascript"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-remote-config.js" type="text/javascript"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js" type="text/javascript"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js" type="text/javascript"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-performance.js" type="text/javascript"></script>
    </head>
    <body class="pb-10 bg-slate-50">
        <!--Top Bar-->
        <div class="fixed top-0 left-0 w-full h-14 md:h-16 bg-blue-600 z-30 py-1.5 px-3 sm:px-3.5">
            <div class="max-w-4xl mx-auto h-full flex items-center justify-between">
                <div class="relative pb-3.5 pr-1" onclick="getTeamIndex()">
                    <h1 class="md:text-2xl text-xl text-blue-50">FRC #7589</h1>
                    <span class="absolute bottom-0 text-white">Scouting</span>
                </div>
            </div>
        </div>

        <div class="hidden" id="loadingScreen">
            <div class="h-72 w-full flex flex-col items-center justify-center space-y-2 text-blue-600">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>           
                <span>Loading</span>
            </div>
        </div>

        <div class="hidden" id="noResultScreen">
            <div class="h-72 w-full flex flex-col items-center justify-center space-y-2 text-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 16.318A4.486 4.486 0 0012.016 15a4.486 4.486 0 00-3.198 1.318M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" />
                </svg>
                <span>No Result</span>
            </div>
        </div>

        <!--Contents-->
        <div class="max-w-4xl mx-auto mt-14 md:mt-16">
            <!-- Team index-->
            <div class="w-full space-y-3 hidden p-2" id="teamIndexScreen">
                <button 
                    id="tbaAddTeamBtn"
                    class="hidden inline-flex justify-center items-center space-x-1.5 rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    onclick="addTeamViaTBA()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden md:block">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z" />
                    </svg>                      
                    <span>Add Teams via Event(Powered by TBA)</span>
                </button>
                <button 
                    class="inline-flex justify-center items-center space-x-1.5 rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    onclick="addTeam()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden md:block">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>                                          
                    <span>Add Team</span>
                </button>
                <h1 class="text-center text-2xl lg:text-4xl text-blue-800">Teams</h1>
                <div class="flex flex-col items-center justify-center w-full space-y-3" id="team-index">
                    <div class="h-screen w-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>                          
                    </div>
                </div>
                <button 
                    class="z-30 fixed bottom-3 right-3 rounded-full w-14 h-14 lg:w-16 lg:h-16 text-blue-200 bg-blue-700 flex items-center justify-center text-center text-3xl"
                    onclick="recordCreate()">
                    <span class="mb-1 lg:mb-1">+</span>
                </button>
            </div>

            <!-- Show Team -->
            <div class="w-full hidden" id="teamViewScreen">
                <div class="bg-blue-100 h-40 lg:h-52 flex flex-col justify-center items-start p-3 lg:p-6">
                    <h1 class="text-center text-2xl lg:text-4xl text-blue-800">Team #<span id="teamID"></span>, "<span id="teamName"></span>"</h1>
                    <h3 class="text-center text-base lg:text-lg text-blue-800 italic">Rookie year: <span id="teamRookieYear"></span></h3>
                </div>
                <div class="space-y-2">
                    <div class="flex space-x-1 items-center" id="teamContainer" current="teamRecordList">
                        <button class="flex-1 py-3 border-b-2 border-blue-500 text-blue-800 tab-button" page="teamRecordList">
                            Records
                        </button>
                        <button class="flex-1 py-3 border-b-0 border-blue-500 text-blue-800 tab-button" page="teamInfo">
                            Info
                        </button>
                    </div>
                    <div class="px-4">
                        <div class="flex flex-col items-center justify-center w-full space-y-3" id="teamRecordList"></div>
                        <div class="text-slate-600 hidden prose" id="teamInfo"></div>
                    </div>
                </div>
                <button 
                    id="recordCreateBtn"
                    class="z-30 fixed bottom-3 right-3 rounded-full w-14 h-14 lg:w-16 lg:h-16 text-blue-200 bg-blue-700 flex items-center justify-center text-center text-3xl"
                    onclick="recordCreate()">
                    <span class="mb-1 lg:mb-1">+</span>
                </button>
            </div>

            <!-- Create Record -->
            <div class="w-full p-2 pt-5 lg:p-5 hidden" id="recordCreateScreen">
                <div class="shadow-lg bg-white rounded-md md:rounded-lg">
                    <div class="sm:overflow-hidden">
                        <div class="space-y-4 px-4 py-5 sm:p-6" id="form_content">
                            
                        </div>
                        <input hidden id="team_id"/>
                    </div>
                    <div class="bg-slate-100 px-4 py-3 text-right sm:px-6">
                        <button onclick="recordSave()" type="button" class="inline-flex justify-center rounded-md border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none border-indigo-500 border-2 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!--Error Mask-->
        <div class="h-screen w-screen bg-red-500 z-40 fixed top-0 left-0 flex-col items-center justify-center hidden" id="errorMask">
            <h1 class="text-center text-3xl text-red-200" id="error-title">Error!</h1>
            <p class="text-center text-lg text-red-200" id="error-message">message</p>
        </div>


        <!-- Utils -->
        <script>
            function _uuid() {
                var d = Date.now();
                if (typeof performance !== 'undefined' && typeof performance.now === 'function'){
                    d += performance.now(); //use high-precision timer if available
                }
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = (d + Math.random() * 16) % 16 | 0;
                    d = Math.floor(d / 16);
                    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                });
            }

            function tba_available() {
                return typeof getConfig("tba_key")._value !== null;
            }

            function getRate(data) {
                var formula = getConfig("formula")._value;
                var parameters = JSON.parse(getConfig("parameters")._value);
                parameters.forEach((parameter) => {
                    formula = formula.replace(parameter.alias, data[parameter.alias]);
                });
                return eval(formula);
            }

            async function isOnline() {
                if('onLine' in navigator) {
                    console.log(navigator.onLine);
                    return navigator.onLine;
                } else {
                    console.log("trying");
                    return await axios.get('https://www.google.com').then(() => {
                        return true;
                    }).catch(e => {
                        return false;
                    });
                }
            }
        </script>

        <!-- Firebase -->
        <script>
            // https://firebase.google.com/docs/web/setup#available-libraries
          
            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
                apiKey: "AIzaSyCQ5cg4VRFiVxeT6JQPKI1vd3kB938w_g0",
                authDomain: "frc-7589.firebaseapp.com",
                databaseURL: "https://frc-7589-default-rtdb.firebaseio.com",
                projectId: "frc-7589",
                storageBucket: "frc-7589.appspot.com",
                messagingSenderId: "283240547457",
                appId: "1:283240547457:web:ce55f744bc4b4d46653980",
                measurementId: "G-2EB11FYT18"
            };
          
            firebase.initializeApp(firebaseConfig);
            const analytics = firebase.analytics();
            const db = firebase.firestore();
            const remoteConfig = firebase.remoteConfig();
            const auth = firebase.auth();
            const messaging = firebase.messaging();
            const provider = new firebase.auth.GoogleAuthProvider();
            const perf = firebase.performance();
            provider.setCustomParameters({
                'hd': 'lssh.tp.edu.tw'
            });
            
            var actionCodeSettings = {
                url: 'https://frc7589-scouting.coyu.cc',
                handleCodeInApp: true
            };  

            firebase.firestore().settings({
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });

            firebase.firestore().enablePersistence()
                .catch((err) => {
                    alert(err.code);
                    if (err.code == 'failed-precondition') {
                        // Multiple tabs open, persistence can only be enabled
                        // in one tab at a a time.
                        // ...
                    } else if (err.code == 'unimplemented') {
                        // The current browser does not support all of the
                        // features required to enable persistence
                        // ...
                    }
                });

            remoteConfig.settings.minimumFetchIntervalMillis = 3600000;

            remoteConfig.defaultConfig = {
                "tba_key": null,
                "parameters": "[{\"name\":\"[Auto]Cube Count\",\"type\":\"number\",\"alias\":\"auto_cube\"},{\"name\":\"[Auto]Cone Count\",\"type\":\"number\",\"alias\":\"auto_cone\"},{\"name\":\"Cube Count\",\"type\":\"number\",\"alias\":\"cube\"},{\"name\":\"Cone Count\",\"type\":\"number\",\"alias\":\"cone\"},{\"name\":\"Robot Design \",\"type\":\"textarea\",\"alias\":\"robotDesign\"},{\"name\":\"Drive Base\",\"type\":\"textarea\",\"alias\":\"driveBase\"},{\"name\":\"Note\",\"type\":\"textarea\",\"alias\":\"note\"}]",
                "formula": "((auto_cube+auto_cone*1.2)*0.7+(cone+cube)*0.3)",
                "eventKey": "2023casd"
            };

            messaging.usePublicVapidKey('BI3uCo1Esg_eHJOfq9iQcMCWzT6AeANuzHkBf-RcG0ZgsMF6eNaFZbp205s5is9vxjay7-rMeCim--Qascb1wqg');

            messaging.onMessage((payload) => {
                console.log('Message received. ', payload);
            });

            function getConfig(key) {
                return remoteConfig.getValue(key);
            }

            function fetchSettings(silent = false) {
                remoteConfig.fetchAndActivate()
                .then(() => {
                    if(!silent) showMessage("config fetched");
                })
                .catch((err) => {
                    showMessage("FAILED to fetch config", true, 'warning');
                });
            }

            
            async function storeRecord(key, data) {
                const online = await isOnline();
                showMessage("Saving record...");
                if(!online) showTeam(data.team_number);
                db.collection("records").doc(key).set(data, { merge: true })
                    .then(() => {
                        showMessage("Record successfully sotred!");
                        if(online) showTeam(data.team_number);
                    })
                    .catch((error) => {
                        showMessage("FAILED to store record", true, 'error');
                    });
            }
        </script>

        <!-- Service Worker -->
        <script>
            if('serviceWorker' in navigator) {
                console.log('Registering service worker');
                try {
                    navigator.serviceWorker.register("./service-worker.js").then((reg) => {
                        messaging.useServiceWorker(reg);
                    });

                    messaging.requestPermission().then(function() {
                        messaging_token = localStorage.getItem("messaging_token");
                        if(messaging_token === null) {
                            messaging.getToken().then(function(currentToken) {
                                var id = currentToken.split(':')[0];
                                db.collection('pushUsers').doc(id).set({'token': currentToken});
                                localStorage.setItem("messaging_token", currentToken);
                            });
                        } else {
                            var id = ckv.split(':')[0];
                            db.collection('pushUsers').doc(id).set({'token': messaging_token});
                        }
                    }).catch(function(err) {
                        console.log('Unable to receive message', err);
                    });
                } catch(e) {
                    console.warn('Failed to register service worker, err:' + e);
                }
            }
        </script>

        <!-- Event Listners -->
        <script>
            window.addEventListener('load', async (event) => {
                if('onLine' in navigator) {
                    changeDBMode(navigator.onLine, true);
                    if(navigator.onLine) {
                        fetchSettings(true);
                    }
                }
            });

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    getTeamIndex();
                } else {
                    if(await userLogin()) {
                        getTeamIndex();
                    }
                }
            });

            window.addEventListener('offline', () => { 
                changeDBMode(false);
            });

            window.addEventListener('online', () => { 
                changeDBMode(true);
                fetchSettings(true);
            });

            document.getElementById('teamContainer').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-button')) {
                    if(document.getElementById('teamContainer').getAttribute('current') != e.target.getAttribute('page')) {
                        document.getElementById(document.getElementById('teamContainer').getAttribute('current')).classList.toggle('hidden');
                        document.getElementById(e.target.getAttribute('page')).classList.toggle('hidden');
                        e.target.classList.replace('border-b-0', 'border-b-2');
                        document.querySelector(`[page=${document.getElementById('teamContainer').getAttribute('current')}]`).classList.replace('border-b-2', 'border-b-0');
                        document.getElementById('teamContainer').setAttribute('current', e.target.getAttribute('page'));
                    }
                }
            });
        </script>

        <!-- UI -->
        <script>
            var last_page;

            function updateEleText(id, text) {
                document.getElementById(id).innerText = text;
            }

            function updateEleHTML(id, html) {
                document.getElementById(id).innerHTML = html;
            }

            function showMessage(title, top = false, type = 'info', after) {

                let timerInterval;

                console.log(title);

                switch(type) {
                    case 'info':
                        bgColor = 'bg-slate-800';
                        textColor = 'text-slate-50';
                        break;
                    case 'warning':
                        bgColor = 'bg-amber-500';
                        textColor = 'text-amber-100';
                        break;
                    case 'error':
                        bgColor = 'bg-red-500';
                        textColor = 'text-red-100';
                        break;
                }

                Swal.fire({
                    title: title,
                    position: top ? 'top' : 'bottom',
                    timer: 1500,
                    timerProgressBar: true,
                    willClose: () => {
                        clearInterval(timerInterval);
                        after
                    },
                    showClass: {
                        popup: `
                        animate__animated
                        animate__fadeInUp
                        animate__faster
                        `
                    },
                    hideClass: {
                        popup: `
                        animate__animated
                        animate__fadeOutDown
                        animate__faster
                        `
                    },
                    customClass: {
                        container: 'p-1.5',
                        title: `p-2.5 ${textColor} text-base font-medium`,
                        popup: `rounded-md ${bgColor}`
                    },
                    padding: '0',
                    grow: 'row',
                    showConfirmButton: false,
                    showCloseButton: false,
                    backdrop: false,
                    heightAuto: false
                });
            }
        
            function showPage(name) {
                if(last_page != name) document.getElementById(name).classList.replace("hidden", "box");
                if(last_page != null && last_page != name) document.getElementById(last_page).classList.replace("box", "hidden");
                last_page = name;
            }

            function copyHTML(target, source) {
                document.getElementById(target).innerHTML = document.getElementById(source).innerHTML;
            }
        </script>

        <!-- Actions -->
        <script>

            async function sendPassswordReset() {
                await Swal.fire({
                    title: 'Forgot Password',
                    html: `<input type="text" id="email" class="swal2-input w-7/8" placeholder="Email">
                    <button class="text-blue-700 mt-4 text-sm" onclick="userLogin()">Login?</button>`,
                    confirmButtonText: 'Send email',
                    focusConfirm: false,
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        const email = Swal.getPopup().querySelector('#email').value;

                        if (!email) {
                            Swal.showValidationMessage(`Please enter your email`);
                        }

                        return await auth.sendPasswordResetEmail(email)
                            .then(() => {
                                return true;
                            })
                            .catch((error) => {
                                var errorCode = error.code;
                                var errorMessage = error.message;
                                Swal.showValidationMessage(`Wrong Email`);
                            });
                    },
                    showClass: {
                        popup: `
                        animate__animated
                        animate__fadeInUp
                        animate__faster
                        `
                    },
                    hideClass: {
                        popup: `
                        animate__animated
                        animate__fadeOutDown
                        animate__faster
                        `
                    },
                    customClass: {
                        container: 'p-1.5',
                        htmlContainer: 'm-0 max-w-full flex flex-col spacep-y-2',
                        popup: 'max-w-lg w-full'
                    },
                    allowOutsideClick: false
                }).then((result) => {
                    showMessage("Password rest email Sent!");
                    setTimeout(() => {
                        userLogin();
                    }, 1500);
                });
            }

            async function userLogin() {
                await Swal.fire({
                    title: 'Account Login',
                    html: `<input type="text" id="email" class="swal2-input w-7/8" placeholder="Email">
                    <input type="password" id="password" class="swal2-input w-7/8" placeholder="Password">
                    <button class="text-blue-700 mt-4 text-sm" onclick="sendPassswordReset()">Forget Password?</button>`,
                    confirmButtonText: 'Login',
                    focusConfirm: false,
                    showLoaderOnConfirm: true,
                    preConfirm: async () => {
                        const email = Swal.getPopup().querySelector('#email').value;
                        const password = Swal.getPopup().querySelector('#password').value;

                        if (!email || !password) {
                            Swal.showValidationMessage(`Please enter email and password`);
                        }

                        return await auth.signInWithEmailAndPassword(email, password)
                            .then((userCredential) => {
                                var user = userCredential.user;
                                return user;
                            })
                            .catch((error) => {
                                var errorCode = error.code;
                                var errorMessage = error.message;
                                Swal.showValidationMessage(`Wrong Email or Password`);
                            });
                    },
                    showClass: {
                        popup: `
                        animate__animated
                        animate__fadeInUp
                        animate__faster
                        `
                    },
                    hideClass: {
                        popup: `
                        animate__animated
                        animate__fadeOutDown
                        animate__faster
                        `
                    },
                    customClass: {
                        container: 'p-1.5',
                        htmlContainer: 'm-0 max-w-full flex flex-col spacep-y-2',
                        popup: 'max-w-lg'
                    },
                    allowOutsideClick: false
                }).then((result) => {
                    showMessage("Login Successful");
                });

                return true;
            }

            function getTeamIndex() {
                copyHTML("team-index", "loadingScreen");
                showPage("teamIndexScreen");
                if(tba_available()) {
                    document.getElementById("tbaAddTeamBtn").classList.remove("hidden");
                }
                getTeams().then((teams) => { 
                    if(!teams.empty) {
                        
                        var html = "";
                        teams.forEach(async (team) => {
                            var teamData = team.data();
                            var rate = 0;
                            await getAllRecords(team.id).then((records) => {
                                records.forEach((record) => {
                                    var recordData = record.data();
                                    rate += getRate(recordData.parameters);
                                });
                                html += '<div class="bg-blue-100 rounded-lg w-full p-3 lg:p-5 space-y-3" onclick="showTeam(\''+ team.id +'\')">' +
                                        '<div><h1 class="text-xl xl:text-2xl">Team #' + teamData.info.team_number +'</h1><h2 class="xl:text-lg">'+ teamData.info.nickname +'</h2></div>'+
                                        '<div class="flex items-center justify-between space-x-2"><div class="flex-1 bg-blue-200 rounded-lg flex flex-col p-4">' +
                                        '<h3 class="text-lg lg:text-xl flex space-x-1.5 items-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg><span>Rate:</span></h3>'+
                                        '<p class="text-4xl font-bold text-center">'+ Math.round(rate/records.size*100)/100 +'</p></div>'+
                                        '<div class="flex-1 bg-blue-200 rounded-lg flex flex-col p-4"><h3 class="text-lg lg:text-xl flex space-x-1.5 items-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" /></svg><span>Records:</span></h3>'+
                                        '<p class="text-4xl font-bold text-center">' + records.size + '</p></div></div></div>';
                            });
                            updateEleHTML("team-index", html);
                        });
                    } else {
                        copyHTML("team-index", "noResultScreen");
                    }
                });
            }

            function addTeam() {
                Swal.fire({
                    title: 'Enter Team Number',
                    input: 'number',
                    inputAttributes: {
                        autocapitalize: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Search',
                    showLoaderOnConfirm: true,
                    preConfirm: (number) => {
                        if('onLine' in navigator) {
                            if(!navigator.onLine) {
                                return {
                                    requireName: true,
                                    number: number
                                };
                            }
                        }
                        return axios.get("https://www.thebluealliance.com/api/v3/team/frc" + number, {
                                    headers: {
                                        "accept": "application/json",
                                        "X-TBA-Auth-Key": getConfig("tba_key")._value
                                    }
                                }).then(res => {
                                    if(res.status == 200) {
                                        return res.data;
                                    } else {
                                        Swal.showValidationMessage(
                                            `Request failed`
                                        );
                                    }
                                }).catch(error => {
                                    Swal.showValidationMessage(
                                        `Request failed: ${error}`
                                    );
                                });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed) {
                        if(result.value.requireName) {
                            Swal.fire({
                                title: 'Enter Team Name',
                                input: 'text',
                                inputAttributes: {
                                    autocapitalize: 'off'
                                },
                                preConfirm: (input) => {
                                    return input;
                                },
                                showCancelButton: true,
                                confirmButtonText: 'Add',
                                showLoaderOnConfirm: true,
                            }).then((response) => {
                                if (response.isConfirmed) {
                                    Swal.fire({
                                        title: `Adding FRC # ${result.value.number}\n(aka "${response.value}") ?`,
                                        showCancelButton: true,
                                        confirmButtonText: 'Add',
                                    }).then((action) => {
                                        if(action.isConfirmed) storeTeam(result.value.number.toString(), {
                                            info: {
                                                team_number: result.value.number.toString(),
                                                nickname: response.value,
                                            },
                                            offline: true
                                        });
                                        getTeamIndex();
                                    });
                                }
                            });
                        } else {
                            Swal.fire({
                                title: `Adding FRC # ${result.value.team_number}\n(aka "${result.value.nickname}") ?`,
                                showCancelButton: true,
                                confirmButtonText: 'Add',
                            }).then((response) => {
                                const awards = async () => {
                                    const data =  await axios.get(`https://www.thebluealliance.com/api/v3/team/frc${result.value.team_number}/awards`, {
                                                headers: {
                                                    "accept": "application/json",
                                                    "X-TBA-Auth-Key": getConfig("tba_key")._value
                                                }
                                            }).then(res => {
                                                console.table(res.data);
                                                if(res.status == 200) {
                                                    return res.data;
                                                }
                                                return [];
                                            }).catch(error => {
                                                console.log(error);
                                                return [];
                                            });
                                    return data;
                                };
                                awards().then(awards_result => {
                                    var data = {
                                        info: result.value,
                                        awards: awards_result
                                    };
                                    console.log(data);
                                    if(response.isConfirmed) storeTeam(result.value.team_number.toString(), data);
                                    getTeamIndex();
                                });
                            });
                        }
                    }
                });
            }
        
            function showTeam(number) {
                document.getElementById('teamContainer').setAttribute('current', 'teamRecordList');
                document.getElementById('teamRecordList').classList.remove('hidden');
                document.getElementById('teamInfo').classList.add('hidden');
                document.querySelector('[page=teamRecordList]').classList.replace('border-b-0', 'border-b-2');
                document.querySelector('[page=teamInfo]').classList.replace('border-b-2', 'border-b-0');

                getTeams(number).then((team) => {
                    (async () => {
                        if(!team.empty) {
                            var teamData = team.data();
                            updateEleHTML("teamRecordList", "");
                            showPage("teamViewScreen");
                            updateEleText("teamID", teamData.info.team_number);
                            updateEleText("teamName", teamData.info.nickname);
                            updateEleText("teamRookieYear", teamData.info.rookie_year);
                            document.getElementById('recordCreateBtn').setAttribute('onclick', `recordCreate(${number})`);
    
                            if('onLine' in navigator && teamData.offline) {
                                if(navigator.onLine) {
                                    const info = await axios.get(`https://www.thebluealliance.com/api/v3/team/frc${number}`, {
                                                                headers: {
                                                                    "accept": "application/json",
                                                                    "X-TBA-Auth-Key": getConfig("tba_key")._value
                                                                }
                                                            }).then(res => {
                                                                if(res.status == 200) {
                                                                    return res.data;
                                                                }
                                                            }).catch(error => {
                                                                showMessage("FAILED to fetch team info", true, 'warning');
                                                            });
                                    const awards = await axios.get(`https://www.thebluealliance.com/api/v3/team/frc${number}/awards`, {
                                                                headers: {
                                                                    "accept": "application/json",
                                                                    "X-TBA-Auth-Key": getConfig("tba_key")._value
                                                                }
                                                            }).then(res => {
                                                                if(res.status == 200) {
                                                                    return res.data;
                                                                }
                                                            }).catch(error => {
                                                                showMessage("FAILED to fetch team info", true, 'warning');
                                                            });
                                    team.ref.update({
                                        info: info,
                                        awards: awards,
                                        offline: firebase.firestore.FieldValue.delete()
                                    }).then(() => {
                                        showMessage("Team info successfully updated!");
                                        showTeam(number);
                                    })
                                    .catch((error) => {
                                        showMessage("FAILED to update team info", true, 'error');
                                    });
                                }
                            }
                            

                            var html = "<h3>Awards</h3><ol>";

                            if(teamData.awards !== undefined) {
                                teamData.awards.forEach((award) => {
                                    html += "<li><ul>";
                                    Object.keys(award).forEach((key) => {
                                        if(typeof award[key] === "object") return;
                                        html += '<li>' + key + ': ' + award[key] + '</li>';
                                    });
                                    html += "</ul></li>";
                                });
                            }
                            html += "</ol><h3>About</h3><ul>";
                            if(typeof teamData.info !== undefined) {
                                Object.keys(teamData.info).forEach((key) => {
                                    if(key == "key" || key == "nickname" || key == "team_number" || teamData.info[key] == null) return;
                                    html += '<li>' + key + ': ' + (key == "website" ? '<a href="' + teamData.info[key] + '">' + teamData.info[key] + '</a>' : teamData.info[key] ) + '</li>';
                                });
                            }
                            html += "</ul>";
                            updateEleHTML("teamInfo", html);
                        }
                        getAllRecords(number).then((records) => {
                            if(!records.empty) {
                                var htmlCode = "";
                                records.forEach((record) => {
                                    var record_data = record.data();
                                    htmlCode += `<div class="bg-blue-50 rounded-lg w-full p-3 lg:p-5 space-y-2 relative">
                                        <button class="w-5 h-5 absolute top-2 right-2" onclick="deleteRecord('${record.id}', '${number}')">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                            </svg>
                                        </button>
                                        <div>
                                            <h1 class="text-lg flex items-center space-x-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                                                </svg>
                                                <span>${record.id}</span>
                                            </h1>
                                            <h2 class="text-sm flex items-center space-x-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <span>${moment(new Date(record_data.timestamp.seconds*1000)).format('YYYY/MM/DD, HH:mm:ss')}</span>
                                            </h2>
                                        </div>
                                        <div class="prose w-full">
                                            <ul>`;
                                    Object.keys(record_data.parameters).forEach((key) => {
                                        htmlCode += `<li class="text-blue-800 space-x-1">${key}:<span class="font-bold">${record_data.parameters[key]}</span></li>`;
                                    });
                                    htmlCode += '</ul></div></div>';
                                });
                                updateEleHTML("teamRecordList", htmlCode);
                            } else {
                                copyHTML("teamRecordList", "noResultScreen");
                            }
                        });
                    })();
                });
            }

            function addTeamViaTBA() {
                if('onLine' in navigator) {
                    if(!navigator.onLine) {
                        Swal.fire({
                            icon: "warning",
                            title: "Internet Connection Required!",
                            text: "Please connect to the Internet before using this function."
                        });
                        return;
                    };
                }

                (async () => {
                    const inputOptions = axios.get(
                        "https://www.thebluealliance.com/api/v3/team/frc7589/events/keys",
                        {
                            headers: {
                                "accept": "application/json",
                                "X-TBA-Auth-Key": getConfig("tba_key")._value
                            }
                        }).then(res => {
                            if(res.status == 200) {
                                var result = {};
                                res.data.forEach((key) => {
                                    result[key] = key;
                                });
                                return result;
                            }
                        }).catch(error => {
                            Swal.showValidationMessage(
                                `Request failed: ${error}`
                            );
                        });

                    Swal.fire({
                        title: 'Choose the Event Key:',
                        input: 'select',
                        inputOptions: inputOptions,
                        inputValue: getConfig("eventKey")._value,
                        showCancelButton: true,
                        confirmButtonText: 'Selete',
                        showLoaderOnConfirm: true,
                        preConfirm: (value) => {
                            return axios.get("https://www.thebluealliance.com/api/v3/event/" + value + "/teams/keys", {
                                headers: {
                                    "accept": "application/json",
                                    "X-TBA-Auth-Key": getConfig("tba_key")._value
                                }
                            }).then(res => {
                                if(res.status == 200) {
                                    return res.data;
                                }
                            }).catch(error => {
                                console.log(error.toJSON());
                            });
                        },
                        customClass: {
                            input: "px-3 py-2 bg-white border shadow-sm border-slate-300 placeholder-slate-400 disabled:bg-slate-50 disabled:text-slate-500 disabled:border-slate-200 focus:outline-none focus:border-sky-500 focus:ring-sky-500 rounded-md sm:text-sm focus:ring-1 invalid:border-pink-500 invalid:text-pink-600 focus:invalid:border-pink-500 focus:invalid:ring-pink-500 disabled:shadow-none"
                        },
                        allowOutsideClick: () => !Swal.isLoading()
                    }).then((result) => {
                        if(result.isConfirmed) {
                            Swal.fire({
                                title: `Add ${result.value.length} teams include?`,
                                showCancelButton: true,
                                confirmButtonText: 'Add',
                                showLoaderOnConfirm: true,
                                allowOutsideClick: () => !Swal.isLoading(),
                                preConfirm: () => {
                                    result.value.forEach((team) => {
                                        (async () => {

                                            const info = await axios.get(`https://www.thebluealliance.com/api/v3/team/${team}`, {
                                                            headers: {
                                                                "accept": "application/json",
                                                                "X-TBA-Auth-Key": getConfig("tba_key")._value
                                                            }
                                                        }).then(res => {
                                                            console.table(res.data);
                                                            if(res.status == 200) {
                                                                return res.data;
                                                            }
                                                            return [];
                                                        }).catch(error => {
                                                            console.log(error);
                                                            return [];
                                                        });

                                            const awards = await axios.get(`https://www.thebluealliance.com/api/v3/team/${team}/awards`, {
                                                            headers: {
                                                                "accept": "application/json",
                                                                "X-TBA-Auth-Key": getConfig("tba_key")._value
                                                            }
                                                        }).then(res => {
                                                            console.table(res.data);
                                                            if(res.status == 200) {
                                                                return res.data;
                                                            }
                                                            return [];
                                                        }).catch(error => {
                                                            console.log(error);
                                                            return [];
                                                        });

                                            var data = {
                                                info: info,
                                                awards: awards
                                            };

                                            console.log(data);

                                            storeTeam(info.team_number.toString(), data);
                                        })();
                                    });
                                    getTeamIndex();
                                }
                            });
                        }
                    });
                })();
            }
        
            async function recordCreate(number = null) {
                if(number == null) {
                    number = await Swal.fire({
                            title: 'Enter Team Number',
                            input: 'number',
                            inputAttributes: {
                                autocapitalize: 'off'
                            },
                            confirmButtonText: 'Start',
                        }).then((result) => {
                            if(result.isConfirmed) {
                                return result.value;
                            }
                        });
                }
                console.log(number);
                var html = `<h1 class="text-lg lg:text-xl font-bold">Record of #<span id="recordTeamID">${number}</span></h1>`;
                JSON.parse(getConfig("parameters")._value).forEach((parameter) => {
                    if(parameter.type == "textarea") {
                        html += `<div>
                                    <label for="${parameter.alias}" class="block text-sm font-medium text-gray-700">${parameter.name}</label>
                                    <div class="mt-1">
                                        <textarea id="${parameter.alias}" name="${parameter.alias}" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="${parameter.name}"></textarea>
                                    </div>
                                </div>`;
                    } else {
                        html += `<div>
                                    <label for="${parameter.alias}" class="block text-sm font-medium text-gray-700">${parameter.name}</label>
                                    <div class="mt-1">
                                        <input id="${parameter.alias}" name="${parameter.alias}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" value="${(parameter.type == "number" ? 0 : '')}" placeholder="${parameter.name}" type="${parameter.type}"/>
                                    </div>
                                </div>`;
                    }
                });
                updateEleHTML("form_content", html);
                showPage("recordCreateScreen");
            }
        
            function recordSave() {
                
                var data = {
                    team_number: document.getElementById('recordTeamID').innerText.toString(),
                    parameters: {},
                    timestamp: firebase.firestore.Timestamp.now(),
                    userId: auth.currentUser.uid
                };

                JSON.parse(getConfig('parameters')._value).forEach((parameter) => {
                    if(parameter.type == 'number') {
                        data['parameters'][parameter.alias] = Number(document.getElementById(parameter.alias).value);
                    } else {
                        data['parameters'][parameter.alias] = document.getElementById(parameter.alias).value.replace(/\s+/g, "\\n");
                    }
                });

                storeRecord(_uuid(), data);
            }
        </script>
    </body>
</html>